---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(ggplot2)
library(nlme)
library(rstudioapi)
library(ggdendro)
library(viridis)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

```

## Data collection
```{r}
cell_lines <- list.files('./results/unfiltered_dream/', pattern='_.*\\.tsv$') %>% sub(pattern='_.*\\.tsv', replacement='') %>% unique()
merged_data <- tibble()
statparams <- c('stat', 'logFC')
for(statparam in statparams){
  for(cell_line in cell_lines){
    file_list <- list.files('./results/unfiltered_dream/', pattern=paste(cell_line, '_.*__', statparam,'__cons__decoupleroutput.tsv', sep='')) %>% paste('./results/unfiltered_dream/', ., sep='')
    for(file in file_list) {
      file_data <- read_tsv(file, show_col_types=FALSE) %>% separate(...1, into=c('cell_line_treatment','norm', 'diffexp', 'dcmethod'), sep='__', remove=FALSE) %>% separate(cell_line_treatment, into=c('cell_line', 'treatment'), sep='_') %>%
        pivot_longer(cols=c('Androgen':ncol(.)), names_to = 'pathway', values_to = 'scores') %>% select(-dcmethod) %>% mutate(statparam=!!statparam)
      merged_data <- rbind(merged_data, file_data)
    }
  }
}

```

```{r}
merged_data <- merged_data %>% mutate(pipeline=paste(norm, diffexp, sep = '+'))
pipelines <- merged_data %>% distinct(pipeline) %>% pull()
pathways <- merged_data %>% distinct(pathway) %>% pull()
```

```{r}
filt_data <- merged_data %>% filter(pipeline=='NA+deseq2', statparam==!!statparam) %>% mutate(...1=sub(pattern = '__.*', '', ...1)) %>% rename(id=...1)
numeric_data <- filt_data %>% pivot_wider(names_from=pathway, values_from=scores,id_cols = id)
cluster <- numeric_data %>% dist() %>% hclust(., 'ave')

```
```{r}
source('dendro_helpers.R')
statparam='stat'
```


```{r}
clustering_k <- function(merged_data, k){
  cluster_results <- list()
  for (pipeline in pipelines){
    filt_data <- merged_data %>% 
      filter(pipeline==!!pipeline, statparam==!!statparam) %>% 
      mutate(...1=sub(pattern = '__.*', '', ...1)) %>% 
      rename(id=...1)
    numeric_data <- filt_data %>% pivot_wider(names_from=pathway, values_from=scores,id_cols = id) %>% column_to_rownames('id')
    cluster <- numeric_data %>% dist() %>% hclust(., 'ave')
    hcdata <- dendro_data_k(cluster, k)
    cluster_results[[pipeline]] <- hcdata
  }
  return(cluster_results)
}

```

```{r, fig.height=10, fig.width=10}
cluster_results <- clustering_k(merged_data, 32)
for (pipeline in pipelines){
  filt_data <- merged_data %>% 
    filter(pipeline==!!pipeline, statparam==!!statparam) %>% 
    mutate(...1=sub(pattern = '__.*', '', ...1)) %>% 
    rename(id=...1)
  metadata <- filt_data %>% select(-pathway, -scores) %>% distinct() %>% column_to_rownames(.,'id')
  
  hcdata <- cluster_results[[pipeline]]
  p <- plot_ggdendro(hcdata,
                   metadata,
                   'cell_line',
                   fan         = TRUE,
                   label.size  = 1.5,
                   nudge.label = 0.15,
                   expand.y    = 0.8,
                   nclust=11)

  mytheme <- theme(panel.background = element_rect(fill = "black"))
  
  p <- p + theme_void() + mytheme 
  
  dendro <- p + geom_point(data     = metadata, 
                 aes(x    = match(rownames(metadata), hcdata$labels$label),
                     y    = -0.5,
                     fill = as.factor(treatment)),
                 size     = 1.5,
                 shape    = 21,
                 show.legend = FALSE) +
    scale_fill_viridis(discrete = TRUE)
  plotname=paste(pipeline,'fan_dendrogram.png', sep = '__' )
  ggsave(filename=plotname, plot=dendro, height = 10, width=10)
}
```


```{r}
k_values <-c(2,3,4,5,11,32)
rand_results_k <- list
rand_results_long <- tibble()
for(i in k_values){
  rand_results <- matrix(nrow = 5, ncol = 5, 0, dimnames = list(pipelines, pipelines)) %>% as.data.frame()
  row.names(rand_results)
  cluster_results <- clustering_k(merged_data, i)
  for(pipeline1 in pipelines){
    for(pipeline2 in pipelines){
      rand_result <- rand.index(cluster_results[[pipeline1]]$segments$clust, cluster_results[[pipeline2]]$segments$clust)
      rand_results[pipeline1, pipeline2] <- rand_result
    }
  }
  
  rand_results_long <- rand_results %>% 
    rownames_to_column(var='pipeline1') %>% 
    pivot_longer(.,cols=-pipeline1, names_to = 'pipeline2', values_to = 'scores') %>%
    mutate(k=i) %>%
    rowwise() %>%
    mutate(diff = paste(sort(c(pipeline1, pipeline2))[1], sort(c(pipeline1, pipeline2))[2],sep='_vs_')) %>% 
    filter(pipeline1 != pipeline2) %>% 
    distinct(diff,.keep_all = TRUE) %>%
    rbind(., rand_results_long)
}
```

```{r, fig.height=4, fig_width=2}
ggplot(rand_results_long, aes(x=k, y=scores, color=diff)) +
  geom_point() +
  ylim(0,1)

```

```{r, fig.height=5, fig.width=5}
ggplot(rand_results_long, aes(x=factor(k), y=scores, fill=factor(k))) +
  geom_bar(stat = 'identity') +
  ylim(0,1) +
  facet_grid(pipeline1 ~ pipeline2)
```

```{r}
boxplots <- ggplot(rand_results_long, aes(x=diff, y=scores, fill=diff)) +
  geom_boxplot() +
  ylim(0.5,1) +
  theme(axis.text.x = element_text(angle=45, vjust = 1, hjust=1),
        plot.margin=margin(10,10,10,30))
boxplots
```

```{r}
boxplots <- ggplot(rand_results_long, aes(x=factor(k), y=scores, fill=factor(k))) +
  geom_boxplot() +
  ylim(0.5,1) +
  theme(axis.text.x = element_text(angle=60, vjust = 0.9, hjust=1),
        plot.margin=margin(10,10,10,30))
boxplots
```




























