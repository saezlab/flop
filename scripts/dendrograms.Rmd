---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(ggplot2)
library(nlme)
library(rstudioapi)
library(ggdendro)
library(viridis)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

```

## Data collection
```{r}
cell_lines <- list.files('./results/unfiltered_dream/', pattern='_.*\\.tsv$') %>% sub(pattern='_.*\\.tsv', replacement='') %>% unique()
merged_data <- tibble()
statparams <- c('stat', 'logFC')
for(statparam in statparams){
  for(cell_line in cell_lines){
    file_list <- list.files('./results/unfiltered_dream/', pattern=paste(cell_line, '_.*__', statparam,'__cons__decoupleroutput.tsv', sep='')) %>% paste('./results/unfiltered_dream/', ., sep='')
    for(file in file_list) {
      file_data <- read_tsv(file, show_col_types=FALSE) %>% separate(...1, into=c('cell_line_treatment','norm', 'diffexp', 'dcmethod'), sep='__', remove=FALSE) %>% separate(cell_line_treatment, into=c('cell_line', 'treatment'), sep='_') %>%
        pivot_longer(cols=c('Androgen':ncol(.)), names_to = 'pathway', values_to = 'scores') %>% select(-dcmethod) %>% mutate(statparam=!!statparam)
      merged_data <- rbind(merged_data, file_data)
    }
  }
}

```

```{r}
merged_data <- merged_data %>% mutate(pipeline=paste(norm, diffexp, sep = '+'))
pipelines <- merged_data %>% distinct(pipeline) %>% pull()
pathways <- merged_data %>% distinct(pathway) %>% pull()
```

```{r}
filt_data <- merged_data %>% filter(pipeline=='NA+deseq2', statparam==!!statparam) %>% mutate(...1=sub(pattern = '__.*', '', ...1)) %>% rename(id=...1)
numeric_data <- filt_data %>% pivot_wider(names_from=pathway, values_from=scores,id_cols = id)
cluster <- numeric_data %>% dist() %>% hclust(., 'ave')

```
```{r}
source('dendro_helpers.R')
statparam='stat'
```


```{r}
cluster_results <- list()
for (pipeline in pipelines){
  filt_data <- merged_data %>% 
    filter(pipeline==!!pipeline, statparam==!!statparam) %>% 
    mutate(...1=sub(pattern = '__.*', '', ...1)) %>% 
    rename(id=...1)
  numeric_data <- filt_data %>% pivot_wider(names_from=pathway, values_from=scores,id_cols = id) %>% column_to_rownames('id')
  cluster <- numeric_data %>% dist() %>% hclust(., 'ave')
  hcdata <- dendro_data_k(cluster, 11)
  cluster_results[[pipeline]] <- hcdata
}
```

```{r, fig.height=10, fig.width=10}
for (pipeline in pipelines){
  filt_data <- merged_data %>% 
    filter(pipeline==!!pipeline, statparam==!!statparam) %>% 
    mutate(...1=sub(pattern = '__.*', '', ...1)) %>% 
    rename(id=...1)
  metadata <- filt_data %>% select(-pathway, -scores) %>% distinct() %>% column_to_rownames(.,'id')
  hcdata <- cluster_results[[pipeline]]
  p <- plot_ggdendro(hcdata,
                   metadata,
                   'cell_line',
                   fan         = TRUE,
                   label.size  = 1.5,
                   nudge.label = 0.15,
                   expand.y    = 0.8,
                   nclust=11)

  mytheme <- theme(panel.background = element_rect(fill = "black"))
  
  p <- p + theme_void() + mytheme 
  
  dendro <- p + geom_point(data     = metadata, 
                 aes(x    = match(rownames(metadata), hcdata$labels$label),
                     y    = -0.5,
                     fill = as.factor(treatment)),
                 size     = 1.5,
                 shape    = 21,
                 show.legend = FALSE) +
    scale_fill_viridis(discrete = TRUE)
  plotname=paste(pipeline,'fan_dendrogram.png', sep = '__' )
  ggsave(filename=plotname, plot=dendro, height = 10, width=10)
}
```


```{r}
rand_results <- matrix(nrow = 5, ncol = 5, 0, dimnames = list(pipelines, pipelines)) %>% as.data.frame()
row.names(rand_results)
for(pipeline1 in pipelines){
  for(pipeline2 in pipelines){
    rand_result <- rand.index(cluster_results[[pipeline1]]$segments$clust, cluster_results[[pipeline2]]$segments$clust)
    rand_results[pipeline1, pipeline2] <- rand_result
    
  }
  
}
```

