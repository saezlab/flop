---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(ggplot2)
library(nlme)
library(rstudioapi)
library(ggdendro)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

```

## Data collection
```{r}
cell_lines <- list.files('./results/unfiltered_dream/', pattern='_.*\\.tsv$') %>% sub(pattern='_.*\\.tsv', replacement='') %>% unique()
merged_data <- tibble()
statparams <- c('stat', 'logFC')
for(statparam in statparams){
  for(cell_line in cell_lines){
    file_list <- list.files('./results/unfiltered_dream/', pattern=paste(cell_line, '_.*__', statparam,'__cons__decoupleroutput.tsv', sep='')) %>% paste('./results/unfiltered_dream/', ., sep='')
    for(file in file_list) {
      file_data <- read_tsv(file, show_col_types=FALSE) %>% separate(...1, into=c('cell_line_treatment','norm', 'diffexp', 'dcmethod'), sep='__', remove=FALSE) %>% separate(cell_line_treatment, into=c('cell_line', 'treatment'), sep='_') %>%
        pivot_longer(cols=c('Androgen':ncol(.)), names_to = 'pathway', values_to = 'scores') %>% select(-dcmethod) %>% mutate(statparam=!!statparam)
      merged_data <- rbind(merged_data, file_data)
    }
  }
}

```

```{r}
merged_data <- merged_data %>% mutate(pipeline=paste(norm, diffexp, sep = '+'))
pipelines <- merged_data %>% distinct(pipeline) %>% pull()
pathways <- merged_data %>% distinct(pathway) %>% pull()
```

```{r}
filt_data <- merged_data %>% filter(pipeline=='NA+deseq2', statparam==!!statparam, pathway==!!pathway) %>% mutate(...1=sub(pattern = '__.*', '', ...1)) %>% column_to_rownames(.,'...1') 
cluster <- filt_data %>% dist() %>% hclust(., 'ave')

```
```{r}
hcdata <- dendro_data_k(cluster, 11)
source('dendro_helpers.R')
```

```{r}
cols <- c("#a9a9a9", "#1f77b4", "#ff7f0e", "#2ca02c")

p <- plot_ggdendro(hcdata,
                   fan         = TRUE,
                   label.size  = 2,
                   nudge.label = 0.15,
                   expand.y    = 0.8)

mytheme <- theme(panel.background = element_rect(fill = "black"))

p <- p + theme_void() + mytheme

p + geom_point(data     = filt_data, 
               aes(x    = match(rownames(filt_data), hcdata$labels$label),
                   y    = -0.7,
                   fill = as.factor(cell_line)),
               size     = 5,
               shape    = 21,
               show.legend = FALSE) +
  scale_fill_viridis(discrete = TRUE) +
  geom_text(data      = filt_data, 
            aes(x     = match(rownames(filt_data), hcdata$labels$label),
                y     = -0.7,
                label = cell_line),
            size = 3)
```

```{r}
p1 <- plot_ggdendro(hcdata,
                    direction   = "lr",
                    expand.y    = 0.15) +
  theme(axis.text.x      = element_text(color = "#ffffff"),
        panel.background = element_rect(fill  = "#ffffff"),
        axis.ticks       = element_blank()) + 
  scale_color_brewer(palette = "Set1") +
  xlab(NULL) +
  ylab(NULL)


# 'bubblemap'
p2 <- ggplot(filt_data) +
  geom_point(aes(x      = 'cell_line',
                 y      = rownames(filt_data),
                 size   = scores,
                 color  = cell_line),
             show.legend = FALSE) +
  scale_color_viridis(direction = -1, discrete=TRUE) +
  theme_minimal() +
  theme(axis.text.y = element_blank()) +
  xlab(NULL) +
  ylab(NULL)

grid.arrange(p1, p2, ncol = 2, widths = 3:2)
```

