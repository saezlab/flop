---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(tidyverse)
library(ggplot2)
library(nlme)
library(rstudioapi)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

```


## Data collection
```{r}
cell_lines <- list.files('./results/', pattern='_.*\\.tsv$') %>% sub(pattern='_.*\\.tsv', replacement='') %>% unique()
merged_data <- tibble()
for(cell_line in cell_lines){
  file_list <- list.files('./results/', pattern=paste(cell_line, '_.*__stat__cons__decoupleroutput.tsv', sep='')) %>% paste('./results/', ., sep='')
  for(file in file_list) {
    file_data <- read_tsv(file, show_col_types=FALSE) %>% separate(...1, into=c('cell_line_treatment','norm', 'diffexp', 'dcmethod'), sep='__', remove=FALSE) %>% separate(cell_line_treatment, into=c('cell_line', 'treatment'), sep='_') %>%
      pivot_longer(cols=c('Androgen':ncol(.)), names_to = 'pathway', values_to = 'scores') %>% select(-dcmethod)
    merged_data <- rbind(merged_data, file_data)
  }
}
```

## Pathway iteration
```{r}
result_df <-tibble()
anova_df <- tibble()
pathways <- merged_data %>% distinct(pathway) %>% pull()
for(cell_line in cell_lines){
  for(pathway in pathways){
    selected_data <- merged_data %>% filter(cell_line==!!cell_line) %>% filter(pathway==!!pathway)
    
    norm_model <- lme(scores ~ 0 + norm , data = selected_data, random = ~ 1 | treatment)
    diffexp_model <- lme(scores ~ 0 + diffexp , data = selected_data, random = ~ 1 | treatment)
    
    result_norm <- norm_model %>% 
      summary() %>%
      .$tTable %>% 
      as.data.frame() %>% 
      rownames_to_column(var='ID') %>% 
      mutate(norm = sub('norm','',ID)) %>% 
      select(-ID) %>%
      as_tibble() %>% 
      mutate(cell_line=!!cell_line, pathway=!!pathway, eval='norm')
    
    result_diffexp <- diffexp_model %>% 
      summary() %>%
      .$tTable %>% 
      as.data.frame() %>% 
      rownames_to_column(var='ID') %>% 
      mutate(norm = sub('diffexp','',ID)) %>% 
      select(-ID) %>%
      as_tibble() %>% 
      mutate(cell_line=!!cell_line, pathway=!!pathway, eval='diffexp')
    
    result_df <- rbind(result_df, result_norm, result_diffexp)
    
    anova_norm <- norm_model %>%
      anova() %>%
      as_tibble() %>%
      mutate(cell_line=!!cell_line, pathway=!!pathway, eval='norm') %>%
      relocate(where(is.character), .before=where(is.numeric))
    
    anova_diffexp <- diffexp_model %>%
      anova() %>%
      as_tibble() %>%
      mutate(cell_line=!!cell_line, pathway=!!pathway, eval='diffexp') %>%
      relocate(where(is.character), .before=where(is.numeric))
    
    anova_df <- rbind(anova_df, anova_norm, anova_diffexp)
    
  }
}
result_df <- result_df %>% rename(pval = `p-value`)
anova_df <- anova_df %>% rename(pval = `p-value`)
```

## Visualization
```{r}
ggplot(anova_df, aes(eval, pval, fill = ifelse(pval>0.05, 'non significant', 'significant'))) +
  geom_bar(stat='identity') +
  geom_hline(yintercept=0.05) +
  facet_grid(cell_line ~ pathway)
  


```

```{r}
ggplot(selected_data,aes(norm,scores,
              fill=treatment))+
  facet_grid(.~diffexp,scale="free_x",space="free",
             labeller=label_both)+
  guides(alpha = guide_legend(override.aes = list(fill = "darkgray")))+
  geom_boxplot()
```

