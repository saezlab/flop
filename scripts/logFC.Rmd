---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(tidyverse)
library(ggplot2)
library(nlme)
library(rstudioapi)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

```


## Data collection
```{r}
cell_lines <- list.files('./results/', pattern='_.*\\.tsv$') %>% sub(pattern='_.*\\.tsv', replacement='') %>% unique()
merged_data <- tibble()
for(cell_line in cell_lines){
  file_list <- list.files('./results/', pattern=paste(cell_line, '_.*__logFC__cons__decoupleroutput.tsv', sep='')) %>% paste('./results/', ., sep='')
  for(file in file_list) {
    file_data <- read_tsv(file, show_col_types=FALSE) %>% separate(...1, into=c('cell_line_treatment','norm', 'diffexp', 'dcmethod'), sep='__', remove=FALSE) %>% separate(cell_line_treatment, into=c('cell_line', 'treatment'), sep='_') %>%
      pivot_longer(cols=c('Androgen':ncol(.)), names_to = 'pathway', values_to = 'scores') %>% select(-dcmethod)
    merged_data <- rbind(merged_data, file_data)
  }
}
```

## Pathway iteration
```{r}
result_df <-tibble()
anova_df <- tibble()
pathways <- merged_data %>% distinct(pathway) %>% pull()
for(cell_line in cell_lines){
  for(pathway in pathways){
    selected_data <- merged_data %>% filter(cell_line==!!cell_line) %>% filter(pathway==!!pathway)
    
    norm_model <- lme(scores ~ 0 + norm , data = selected_data, random = ~ 1 | treatment)
    diffexp_model <- lme(scores ~ 0 + diffexp , data = selected_data, random = ~ 1 | treatment)
    
    result_norm <- norm_model %>% 
      summary() %>%
      .$tTable %>% 
      as.data.frame() %>% 
      rownames_to_column(var='ID') %>% 
      mutate(norm = sub('norm','',ID)) %>% 
      select(-ID) %>%
      as_tibble() %>% 
      mutate(cell_line=!!cell_line, pathway=!!pathway, eval='norm')
    
    result_diffexp <- diffexp_model %>% 
      summary() %>%
      .$tTable %>% 
      as.data.frame() %>% 
      rownames_to_column(var='ID') %>% 
      mutate(norm = sub('diffexp','',ID)) %>% 
      select(-ID) %>%
      as_tibble() %>% 
      mutate(cell_line=!!cell_line, pathway=!!pathway, eval='diffexp')
    
    result_df <- rbind(result_df, result_norm, result_diffexp)
    
    anova_norm <- norm_model %>%
      anova() %>%
      as_tibble() %>%
      mutate(cell_line=!!cell_line, pathway=!!pathway, eval='norm') %>%
      relocate(where(is.character), .before=where(is.numeric))
    
    anova_diffexp <- diffexp_model %>%
      anova() %>%
      as_tibble() %>%
      mutate(cell_line=!!cell_line, pathway=!!pathway, eval='diffexp') %>%
      relocate(where(is.character), .before=where(is.numeric))
    
    anova_df <- rbind(anova_df, anova_norm, anova_diffexp)
    
  }
}
result_df <- result_df %>% rename(pval = `p-value`)
anova_df <- anova_df %>% rename(pval = `p-value`)
```

## Visualization
```{r}
ggplot(anova_df, aes(eval, pval, fill = ifelse(pval>0.05, 'non significant', 'significant'))) +
  geom_bar(stat='identity', width=0.2) +
  geom_hline(yintercept=0.05) +
  facet_grid(cell_line ~ pathway)
  


```

```{r, fig.width=15,fig.height=7}

ggplot(anova_df, aes(eval, pathway), size=pval) +
  geom_point(aes(eval, pathway, colour = pval<0.05,size=-log(pval)), position = position_dodge(width = 0)) +
  scale_colour_manual(name = 'Significance (pvalue < 0.05)', values = setNames(c('red','darkgrey'),c(T, F)))+
  scale_size(name='-log(pvalue)')+
  xlab('Level') + 
  ylab('Pathways')+
  theme(axis.text.x = element_text(angle = 45,hjust=1,vjust=1)) +
  facet_grid(~ cell_line)
ggsave('scatterpvals_logFC.png',path='./results/', dpi=300)

```
```{r, fig.width=15,fig.height=7}

ggplot(anova_df, aes(cell_line, pathway), size=pval) +
  geom_point(aes(cell_line, pathway, colour = pval<0.05,size=-log(pval)), position = position_dodge(width = 0)) +
  scale_colour_manual(name = 'Significance (pvalue < 0.05)', values = setNames(c('red','darkgrey'),c(T, F)))+
  scale_size(name='-log(pvalue)')+
  xlab('Cell line') + 
  ylab('Pathways')+
  theme(axis.text.x = element_text(angle = 45,hjust=1,vjust=1)) +
  facet_grid(~ eval)
ggsave('scatterpvalspathway_logFC.png',path='./results/', dpi=300)

```


```{r}
library(metap)
acrosspathways_results <- tibble()
acrosscell_results <- tibble()
for(cell_line in cell_lines){
  selected_data_meta <- anova_df %>% 
    filter(cell_line==!!cell_line)
  norm_meta <- selected_data_meta %>% 
    filter(eval=='norm') %>% pull(pval) %>% sumlog()
  diffexp_meta <- selected_data_meta %>% 
    filter(eval=='diffexp') %>% 
    pull(pval) %>% 
    sumlog()
  acrosspathways_results <- c(norm_meta[1], norm_meta[2], norm_meta[3]) %>% 
    as_tibble() %>% 
    mutate(value=!!cell_line, eval='norm', across='Across pathways') %>%
	 relocate(value, eval) %>%
    rbind(acrosspathways_results,.)
  acrosspathways_results <- c(diffexp_meta[1], diffexp_meta[2], diffexp_meta[3]) %>% 
    as_tibble() %>% 
    mutate(value=!!cell_line, eval='diffexp', across='Across pathways') %>% 
    relocate(value, eval) %>%
    rbind(acrosspathways_results,.)
}

for(pathway in pathways){
  selected_data_meta <- anova_df %>% 
    filter(pathway==!!pathway)
  norm_meta <- selected_data_meta %>% 
    filter(eval=='norm') %>% pull(pval) %>% sumlog()
  diffexp_meta <- selected_data_meta %>% 
    filter(eval=='diffexp') %>% 
    pull(pval) %>% 
    sumlog()
  acrosscell_results <- c(norm_meta[1], norm_meta[2], norm_meta[3]) %>% 
    as_tibble() %>% 
    mutate(value=!!pathway, eval='norm', across='Across cell lines') %>% 
    relocate(value, eval) %>%
    rbind(acrosscell_results,.)
  acrosscell_results <- c(diffexp_meta[1], diffexp_meta[2], diffexp_meta[3]) %>% 
    as_tibble() %>% 
    mutate(value=!!pathway, eval='diffexp', across='Across cell lines') %>% 
    relocate(value, eval) %>%
    rbind(acrosscell_results,.)
  
}
metanalysis_results <- rbind(acrosscell_results, acrosspathways_results)
```

```{r}
ggplot(acrosspathways_results, aes(eval, p)) +
  geom_bar(aes(cell_line, p, fill=p<0.05),stat='identity', width=0.5,) +
  scale_fill_manual(name = 'Significance (pvalue < 0.05)', values = setNames(c('red','darkgrey'),c(T, F)))+
  geom_hline(yintercept=0.05) +
  theme(axis.text.x = element_text(angle = 45,hjust=1,vjust=1)) +
  facet_grid(~ eval)
```

```{r}
ggplot(acrosscell_results, aes(pathway, p)) +
  geom_bar(aes(pathway, p, fill=p<0.05),stat='identity', width=0.5,) +
  scale_fill_manual(name = 'Significance (pvalue < 0.05)', values = setNames(c('red','darkgrey'),c(T, F)))+
  geom_hline(yintercept=0.05) +
  theme(axis.text.x = element_text(angle = 45,hjust=1,vjust=1)) +
  facet_grid(~ eval)
```

```{r, fig.width=12,fig.height=4}
axis_titles <- data.frame(
  Species = c("Across cell lines", "Across pathways"),
  axis_title = c("Pathway", "Cell line")
)

ggplot(metanalysis_results, aes(value, eval)) +
  geom_point(aes(value, eval, colour = p<0.05,size=-log(p)), position = position_dodge(width = 0)) +
  scale_colour_manual(name = 'Significance (pvalue < 0.05)', values = setNames(c('red','darkgrey'),c(T, F)))+
  scale_size(name='-log(pvalue)')+
  xlab(' ') + 
  ylab('Method')+
  theme(axis.text.x = element_text(angle = 45,hjust=1,vjust=1)) +
  facet_grid(~across, scales = 'free_x')


ggsave('metanalysisacross_logFC.png',path='./results/', dpi=300)

```